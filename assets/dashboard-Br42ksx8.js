import{Bt as e,Ct as t,Gt as n,It as r,Kt as i,Lt as a,Nt as o,Pt as s,St as ee,Ut as c,Wt as te,an as l,en as ne,jt as u,on as d,qt as f,un as p,xt as m}from"./index-DmwTqtwr.js";import{n as h,r as re,t as ie}from"./useAuth-36znuZB8.js";var ae={class:`content`},oe={class:`topbar`},se={class:`greeting`},ce={class:`top-meta`},le={class:`user`},ue={class:`user-meta`},de={class:`name`},fe={class:`plan`},pe={class:`main`},me={"aria-labelledby":`ov-title`},he={class:`kpi-group`},ge={key:0,class:`kpi`},_e={class:`kpi-value`},ve={class:`kpi`},ye={class:`kpi-value`},be={class:`kpi-sub`},xe={key:1,class:`kpi`},g={class:`kpi-value`},_={key:2,class:`kpi`},v={class:`kpi-value`},y={class:`kpi`},b={class:`kpi-value`},x={class:`grid-12`},S={key:0,class:`card chart-box col-span-8`},C=[`value`],w=[`value`],T=[`value`],E=[`value`],D={key:1,class:`card chart-box col-span-4`},O=[`value`],k=[`value`],A={key:2,class:`card chart-box col-span-12`},j=[`value`],M=[`value`],N=ee({__name:`dashboard`,setup(ee){let N=t(),{userId:P,userName:F,userPlan:Se,getCurrentUser:Ce}=ie();n(()=>{N.loadPersonalization()}),h.register(...re);let I=l([]),L=l([]),R=l([]),z=l({hourly:[],monthly:[],deviceShare:{labels:[],data:[]}}),B=l(null),V=l(null),H=l(null),U=l(null),W={hora:null,mes:null,dispositivo:null},G=l(!1);async function K(){if(!P.value)return console.warn(`UserId not available yet`),[];try{let e=await m.get(`/api/v1/zones?userId=${P.value}`);return console.log(`Zones loaded:`,e),e}catch(e){return console.error(`Error loading zones:`,e),[]}}async function q(e){if(!e)return console.warn(`ZoneId not provided`),[];try{let t=await m.get(`/api/v1/devices?zoneId=${e}`);return console.log(`Devices loaded for zone`,e,`:`,t),t}catch(t){return console.error(`Error loading devices for zone`,e,`:`,t),[]}}function J(e){let t=e%2147483647;return t<=0&&(t+=2147483646),()=>(t=t*16807%2147483647)/2147483647}function we(e){let t=J(e*9301+49297);return Array.from({length:24},(e,n)=>{let r=.05+(n>=18&&n<=22?.2:n>=6&&n<=9?.12:.08),i=(t()-.5)*.04;return Number((r+i).toFixed(3))})}function Te(e){let t=J(e*14071+7);return Array.from({length:7},(e,n)=>{let r=.9+.4*Math.sin(n/7*Math.PI*2),i=(t()-.5)*.2;return Number(Math.max(.2,r+i).toFixed(2))})}function Ee(e){if(!e?.length)return{labels:[],data:[]};let t=e.map(e=>.5+J(e.id*101)()*2),n=t.reduce((e,t)=>e+t,0),r=t.map(e=>Number((e/n*100).toFixed(2)));return{labels:e.map(e=>e.name||`Device ${e.id}`),data:r}}let De=[`12 AM`,`4 AM`,`8 AM`,`12 PM`,`4 PM`,`8 PM`];function Oe(e){return[e[0],e[4],e[8],e[12],e[16],e[20]]}async function Y(){if(console.log(`renderHora called, selectedZoneIdHora:`,B.value),!B.value){console.warn(`No zone selected for hora chart`);return}if(L.value=await q(B.value),console.log(`Devices for hora chart:`,L.value),U.value||=L.value[0]?.id??null,!U.value){console.warn(`No device selected for hora chart`);return}let e=we(U.value),t=Oe(e);console.log(`Generated hourly data:`,t),z.value.hourly=t;let n=document.getElementById(`consumoPorHora`)?.getContext(`2d`);if(!n){console.error(`Canvas context not found for consumoPorHora`);return}W.hora?.destroy(),W.hora=new h(n,{type:`line`,data:{labels:De,datasets:[{label:`Consumo (kWh)`,data:t,borderColor:`#0b2541`,backgroundColor:`rgba(11,37,65,0.2)`,fill:!0,tension:.3}]},options:{responsive:!0,maintainAspectRatio:!1,plugins:{legend:{display:!1}}}}),console.log(`Hora chart rendered successfully`)}async function X(){if(console.log(`renderMes called, selectedZoneIdMes:`,V.value),!V.value){console.warn(`No zone selected for mes chart`);return}let e=Te(V.value);console.log(`Generated monthly data:`,e),z.value.monthly=e;let t=document.getElementById(`consumoPorMes`)?.getContext(`2d`);if(!t){console.error(`Canvas context not found for consumoPorMes`);return}W.mes?.destroy(),W.mes=new h(t,{type:`bar`,data:{labels:[`1`,`2`,`3`,`4`,`5`,`6`,`7`],datasets:[{label:`Consumo por día (kWh)`,data:e,backgroundColor:`#0b2541`}]},options:{responsive:!0,maintainAspectRatio:!1,plugins:{legend:{display:!1}}}}),console.log(`Mes chart rendered successfully`)}async function Z(){if(console.log(`renderDispositivo called, selectedZoneIdDispositivo:`,H.value),!H.value){console.warn(`No zone selected for dispositivo chart`);return}R.value=await q(H.value),console.log(`Devices for dispositivo chart:`,R.value);let{labels:e,data:t}=Ee(R.value);console.log(`Generated device share data:`,{labels:e,data:t}),z.value.deviceShare={labels:e,data:t};let n=document.getElementById(`consumoPorDispositivo`)?.getContext(`2d`);if(!n){console.error(`Canvas context not found for consumoPorDispositivo`);return}W.dispositivo?.destroy(),W.dispositivo=new h(n,{type:`doughnut`,data:{labels:e,datasets:[{data:t,backgroundColor:[`#0b2541`,`#f46161ff`,`#ffd700`,`#4caf50`]}]},options:{responsive:!0,maintainAspectRatio:!1,plugins:{legend:{position:`bottom`}}}}),console.log(`Dispositivo chart rendered successfully`)}async function Q(e){B.value=Number(e.target.value),U.value=null,await Y()}async function ke(e){U.value=Number(e.target.value),await Y()}async function Ae(e){V.value=Number(e.target.value),await X()}async function je(e){H.value=Number(e.target.value),await Z()}let Me=o(()=>z.value.hourly.reduce((e,t)=>e+Number(t||0),0)),Ne=o(()=>{let e=z.value.hourly;return e[e.length-1]??0}),$=o(()=>z.value.monthly.reduce((e,t)=>e+Number(t||0),0)),Pe=o(()=>{let e=z.value.monthly;return e.length?$.value/e.length:0}),Fe=o(()=>$.value*.7),Ie=o(()=>{let e=z.value.hourly;return e.length?e.reduce((e,t)=>e+Number(t||0),0)/e.length*24/4:0});return n(async()=>{if(console.log(`Dashboard mounting...`),await Ce(),console.log(`Current user loaded, userId:`,P.value),I.value=await K(),console.log(`Zones loaded:`,I.value),I.value.length){B.value=I.value[0].id,V.value=I.value[0].id,H.value=I.value[0].id,console.log(`Selected zone IDs set`),await c(),await new Promise(e=>setTimeout(e,200));try{await Y(),await X(),await Z(),G.value=!0,console.log(`All charts rendered successfully`)}catch(e){console.error(`Error rendering charts:`,e)}}else console.warn(`No zones found for user`,P.value)}),ne(P,async(e,t)=>{if(e!==t&&(Object.values(W).forEach(e=>e&&e.destroy()),W={hora:null,mes:null,dispositivo:null},z.value={hourly:[],monthly:[],deviceShare:{labels:[],data:[]}},I.value=[],L.value=[],R.value=[],B.value=null,V.value=null,H.value=null,U.value=null,G.value=!1,e&&(I.value=await K(),I.value.length))){B.value=I.value[0].id,V.value=I.value[0].id,H.value=I.value[0].id,await c(),await new Promise(e=>setTimeout(e,200));try{await Y(),await X(),await Z(),G.value=!0}catch(e){console.error(`Error rendering charts after user change:`,e)}}}),te(()=>{Object.values(W).forEach(e=>e&&e.destroy())}),(t,n)=>(i(),a(`div`,ae,[s(`header`,oe,[s(`div`,se,[s(`h1`,null,[n[0]||=e(`Bienvenido de vuelta, `,-1),s(`strong`,null,p(d(F)),1),n[1]||=e(`.`,-1)])]),s(`div`,ce,[n[3]||=s(`div`,{class:`datetime`},[s(`div`,null,`Jueves 25 - Set`),s(`div`,null,`11:00 am`)],-1),n[4]||=s(`button`,{class:`icon-btn`,"aria-label":`Notificaciones`},null,-1),s(`div`,le,[n[2]||=s(`img`,{class:`avatar`,src:``,alt:`Foto de Jorge Ramírez`},null,-1),s(`div`,ue,[s(`div`,de,p(d(F)),1),s(`div`,fe,p(d(Se)),1)])])])]),s(`main`,pe,[s(`section`,me,[n[14]||=s(`h2`,{id:`ov-title`,class:`section-title`},`Overview`,-1),s(`div`,he,[d(N).kpiCurrent?(i(),a(`article`,ge,[n[5]||=s(`h3`,{class:`kpi-title`},`Consumo actual`,-1),s(`div`,_e,p(Ne.value.toFixed(2))+` kWh`,1),n[6]||=s(`div`,{class:`kpi-sub`},`+10% ahorrado vs ayer`,-1)])):r(``,!0),s(`article`,ve,[n[7]||=s(`h3`,{class:`kpi-title`},`Consumo de hoy`,-1),s(`div`,ye,p(Me.value.toFixed(2))+` kWh`,1),s(`div`,be,`Hasta ahora / `+p(Ie.value.toFixed(2))+` kWh proyectado`,1)]),d(N).kpiMonthly?(i(),a(`article`,xe,[n[8]||=s(`h3`,{class:`kpi-title`},`Consumo mensual`,-1),s(`div`,g,p($.value.toFixed(0))+` kWh`,1),n[9]||=s(`div`,{class:`kpi-sub`},`-80% de una meta de 250 kWh`,-1)])):r(``,!0),d(N).kpiCost?(i(),a(`article`,_,[n[10]||=s(`h3`,{class:`kpi-title`},`Costo estimado`,-1),s(`div`,v,`S/`+p(Fe.value.toFixed(2)),1),n[11]||=s(`div`,{class:`kpi-sub`},`vs S/48 el mes pasado`,-1)])):r(``,!0),s(`article`,y,[n[12]||=s(`h3`,{class:`kpi-title`},`Promedio diario`,-1),s(`div`,b,p(Pe.value.toFixed(1))+` kWh`,1),n[13]||=s(`div`,{class:`kpi-sub`},`Historial últimos 3 meses`,-1)])])]),s(`section`,x,[d(N).chartHourly?(i(),a(`figure`,S,[n[15]||=s(`h3`,null,`Consumo de energía hoy (por hora)`,-1),s(`select`,{value:B.value,onChange:Q,style:{"margin-bottom":`1rem`}},[(i(!0),a(u,null,f(I.value,e=>(i(),a(`option`,{key:e.id,value:e.id},p(e.name),9,w))),128))],40,C),s(`select`,{value:U.value,onChange:ke,style:{"margin-left":`.5rem`,"margin-bottom":`1rem`}},[(i(!0),a(u,null,f(L.value,e=>(i(),a(`option`,{key:e.id,value:e.id},p(e.name),9,E))),128))],40,T),n[16]||=s(`canvas`,{id:`consumoPorHora`},null,-1)])):r(``,!0),d(N).chartDevice?(i(),a(`figure`,D,[n[17]||=s(`h3`,null,`Consumo por dispositivo`,-1),s(`select`,{value:H.value,onChange:je,style:{"margin-bottom":`1rem`}},[(i(!0),a(u,null,f(I.value,e=>(i(),a(`option`,{key:e.id,value:e.id},p(e.name),9,k))),128))],40,O),n[18]||=s(`canvas`,{id:`consumoPorDispositivo`},null,-1)])):r(``,!0),d(N).chartMonthly?(i(),a(`figure`,A,[n[19]||=s(`h3`,null,`Consumo este mes (diario)`,-1),s(`select`,{value:V.value,onChange:Ae,style:{"margin-bottom":`1rem`}},[(i(!0),a(u,null,f(I.value,e=>(i(),a(`option`,{key:e.id,value:e.id},p(e.name),9,M))),128))],40,j),n[20]||=s(`canvas`,{id:`consumoPorMes`},null,-1)])):r(``,!0)])])]))}},[[`__scopeId`,`data-v-082ecfdd`]]);export{N as default};